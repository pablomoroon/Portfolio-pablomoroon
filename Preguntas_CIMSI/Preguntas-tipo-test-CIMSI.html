<!doctype html>
<html lang="es">
<head>
  <meta name="google-adsense-account" content="ca-pub-4549916057843860">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tester CIMSI/PD - Estudio y Examen</title>
  <style>
    :root { --accent:#2563eb; --success:#16a34a; --danger:#dc2626; --muted:#6b7280; }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:#0f172a;color:#e6eef8}
    .app{display:grid;grid-template-columns:1fr 320px;gap:18px;height:100vh;padding:18px}
    .card{background:#071029;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,.6)}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:18px;margin:0;flex:1}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    select{background:#0b1220;border:1px solid #102030;color:inherit;padding:6px 8px;border-radius:6px}
    button{background:var(--accent);border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;white-space:nowrap}
    button.ghost{background:transparent;border:1px solid #14243a}
    .main{display:flex;flex-direction:column;gap:10px}
    .enunciado{min-height:120px;white-space:pre-wrap;padding:12px;border-radius:8px;background:linear-gradient(180deg,#081127,#071029);border:1px solid #14243a}
    .opts{display:flex;flex-direction:column;gap:6px}
    .opt{background:#0a1220;padding:10px;border-radius:8px;border:1px solid #122033;cursor:pointer}
    .opt.selected{outline:2px solid rgba(37,99,235,.25)}
    .opt.correct{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.2)}
    .opt.wrong{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.2)}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .sidebar{display:flex;flex-direction:column;gap:10px}
    .doubts{height:60vh;overflow:auto;background:#061323;padding:8px;border-radius:8px;border:1px solid #102035}
    .progress{height:10px;background:#082033;border-radius:8px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#0ea5e9,#2563eb)}
    @media(max-width:1200px){.app{grid-template-columns:1fr 260px}}
    @media(max-width:900px){.app{grid-template-columns:1fr;height:auto}.sidebar{order:2}}
    @media(max-width:600px){
      body{font-size:15px}h1{font-size:16px}button{font-size:13px;padding:6px 8px}
      .card{padding:12px}.controls{gap:6px}.enunciado{min-height:100px;font-size:14px}
      .opt{padding:8px;font-size:14px}.footer{flex-direction:column;align-items:flex-start}
    }

    /* Pantalla de selecci√≥n de asignatura */
    .landing{
      position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
      background:radial-gradient(1200px 600px at 50% -10%, rgba(37,99,235,.15), transparent), #0b1220;
      padding:24px;
    }
    .landing .box{max-width:900px;width:100%;text-align:center}
    .landing h2{margin:0 0 16px 0; font-size:28px}
    .landing p{margin:0 0 24px 0; color:var(--muted)}
    .landing .grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .bigbtn{
      border:1px solid #1a2742; background:linear-gradient(180deg,#0e1b3a,#0b152c);
      padding:28px 20px; border-radius:16px; font-size:22px; cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease, border-color .2s ease;
      box-shadow:0 10px 24px rgba(2,6,23,.45);
    }
    .bigbtn:hover{transform:translateY(-1px); border-color:#274a8f}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Pantalla de selecci√≥n -->
  <div id="landing" class="landing">
    <div class="box">
      <h2>¬øQu√© asignatura quieres estudiar?</h2>
      <p>Elige una y te llevamos al generador de preguntas.</p>
      <div class="grid">
        <button class="bigbtn" id="btnITIL">üß© CIMSI</button>
        <button class="bigbtn" id="btnITILHard">üî• CIMSI Dif√≠cil</button>
        <button class="bigbtn" id="btnPD">üìò PD</button>
      </div>
    </div>
  </div>

  <!-- App del generador -->
  <div id="app" class="app hidden">
    <div class="card main">
      <header>
        <h1 id="headerTitle">Sin preguntas cargadas</h1>
        <div class="controls">
          <label>Tema</label>
          <select id="temaSelect"><option>Todos</option></select>
          <button id="prevBtn" class="ghost">‚üµ Anterior</button>
          <button id="nextBtn" class="ghost">Siguiente ‚ü∂</button>
          <button id="checkBtn" title="Comprobar">Comprobar</button>
          <button id="doubtBtn" title="Marcar/Demarcar como dudosa">‚òÖ Dudosa</button>
          <button id="examBtn" style="background:#f59e0b">Iniciar Examen (20)</button>
          <button id="regenPDBtn" class="ghost" style="display:none">Generar PD</button>
          <!-- Bot√≥n modo muy dif√≠cil PD -->
          <button id="pdHardBtn" class="ghost" style="display:none;border-color:#b91c1c">PD Muy Dif√≠cil</button>
          <button id="changeSubject" class="ghost" title="Volver a elegir asignatura">Cambiar asignatura</button>
        </div>
      </header>

      <div id="enunciado" class="enunciado">Selecciona una asignatura para cargar preguntas autom√°ticamente, o usa ‚ÄúCarga manual‚Äù.</div>
      <div class="opts" id="opts"></div>

      <div class="footer">
        <div>
          <span id="feedback" style="font-weight:700"></span>
          <div id="solution" style="margin-top:6px;color:#fca5a5"></div>
        </div>
        <div style="width:320px;max-width:100%">
          <div class="progress" aria-hidden><i id="progressBar" style="width:0%"></i></div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px" id="statusText">Estado</div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="card">
        <strong>Preguntas Dudosas</strong>
        <div class="doubts" id="doubtsList">‚Äî</div>
      </div>

      <div class="card">
        <strong>Progreso</strong>
        <div style="margin-top:8px"><span id="progressLabel">0/0</span></div>
        <div style="margin-top:8px;font-size:13px;color:var(--muted)">Filtrar por tema</div>
        <select id="temaFilter" style="width:100%;margin-top:6px"><option>Todos</option></select>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Carga autom√°tica</div>
        <button id="tryAuto">Intentar cargar JSON de la asignatura</button>
        <div id="autoHint" style="margin-top:6px;font-size:12px;color:var(--muted)"></div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Carga manual (archivo local)</div>
        <input type="file" id="fileInput" accept="application/json">
      </div>
    </aside>
  </div>

  <script>
    // ========= Config de asignaturas =========
    const SUBJECTS = {
      ITIL:      { label: 'CIMSI', slug: 'cimsi' },
      ITIL_HARD: { label: 'CIMSI', slug: 'cimsi-hard' }, // CIMSI dif√≠cil
      PD:        { label: 'PD',    slug: 'pd' }
    };
    let selectedSubject = null; // 'ITIL' | 'ITIL_HARD' | 'PD'

    // ========= Estado =========
    let allQuestions = [];
    let questions = [];
    let index = 0;
    let modeExam = false;
    let userAnswers = {};
    let doubts = new Set();
    let checkedQuestions = new Set();
    let difficultyMode = 'normal'; // 'normal' | 'hard'

    // ========= DOM =========
    const landing = document.getElementById('landing');
    const appEl = document.getElementById('app');
    const headerTitle = document.getElementById('headerTitle');
    const enunciado = document.getElementById('enunciado');
    const opts = document.getElementById('opts');
    const feedback = document.getElementById('feedback');
    const solution = document.getElementById('solution');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const doubtsList = document.getElementById('doubtsList');
    const temaSelect = document.getElementById('temaSelect');
    const temaFilter = document.getElementById('temaFilter');
    const tryAutoBtn = document.getElementById('tryAuto');
    const autoHint = document.getElementById('autoHint');
    const regenPDBtn = document.getElementById('regenPDBtn');
    const pdHardBtn = document.getElementById('pdHardBtn');

    const setStatus = (s) => statusText.textContent = s;

    // ========= Utilidades de URL (GitHub Pages friendly) =========
    function baseRoot(){
      const isPages = location.hostname.endsWith('github.io');
      const repoSegment = isPages ? location.pathname.split('/').filter(Boolean)[0] : '';
      return `${location.origin}/${repoSegment ? repoSegment + '/' : ''}`;
    }

    // Candidatos de rutas para cada asignatura
    function jsonCandidatesFor(subjectKey){
      const root = baseRoot(); // maneja GitHub Pages /<repo>/
      if (subjectKey === 'ITIL') {
        return [
          `${root}Preguntas_CIMSI/preguntas_estudioCIMSI.json`,
          `${root}preguntas_estudioCIMSI.json`
        ];
      }
      if (subjectKey === 'ITIL_HARD') {
        // JSON "tipo test" para CIMSI dif√≠cil
        return [
          `${root}Preguntas_CIMSI/preguntas_examenCIMSI.json`,
          `${root}preguntas_examenCIMSI.json`
        ];
      }
      if (subjectKey === 'PD') {
        return [
          `${root}Preguntas_CIMSI/preguntas_estudioPD.json`,
          `${root}preguntas_estudioPD.json`
        ];
      }
      return [];
    }

    // ========= Carga autom√°tica seg√∫n asignatura =========
    async function tryAutoLoadForSubject(subjectKey){
      const candidates = jsonCandidatesFor(subjectKey);
      if (candidates.length) {
        autoHint.textContent = `Buscando en: ${candidates.map(c => c.replace(location.origin,'')).join('  ‚Ä¢  ')}`;
      }
      for(const url of candidates){
        try{
          setStatus('Cargando: ' + url);
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const txt = (await r.text()).replace(/^\uFEFF/, '');
          const data = JSON.parse(txt);
          const arr = Array.isArray(data) ? data : (data.preguntas || []);
          if(!Array.isArray(arr) || arr.length===0) throw new Error('JSON vac√≠o o estructura inesperada');

          // dificultad seg√∫n asignatura
          difficultyMode = (subjectKey === 'ITIL_HARD') ? 'hard' : 'normal';

          allQuestions = arr.map(q => ({...q}));
          questions = allQuestions.slice();
          populateTemas();
          index = 0; modeExam=false; userAnswers={}; doubts=new Set(); checkedQuestions=new Set();
          updateView();
          setStatus('Banco cargado.');
          return true;
        }catch(e){
          console.warn('No se pudo cargar en', url, e);
        }
      }

      // Fallback: si es PD, generamos preguntas autom√°ticamente
      if(subjectKey === 'PD'){
        difficultyMode = 'normal';
        allQuestions = generatePDQuestions();
        questions = allQuestions.slice();
        populateTemas();
        index = 0; modeExam=false; userAnswers={}; doubts=new Set(); checkedQuestions=new Set();
        updateView();
        setStatus('Banco generado para PD.');
        autoHint.textContent = 'Usando preguntas generadas (no se encontr√≥ JSON de PD).';
        return true;
      }

      setStatus('No se pudo cargar autom√°ticamente ning√∫n JSON.');
      alert('No se pudo cargar autom√°ticamente el JSON de la asignatura. Puedes usar "Carga manual".');
      return false;
    }

    // ========= NUEVO: Carga autom√°tica PD muy dif√≠cil =========
    async function tryLoadPDHard(){
      if(selectedSubject !== 'PD'){
        alert('El modo muy dif√≠cil solo est√° disponible para PD.');
        return false;
      }
      const root = baseRoot();
      const candidates = [
        `${root}Preguntas_CIMSI/preguntas_estudioPD_dificil.json`,
        `${root}preguntas_estudioPD_dificil.json`
      ];
      autoHint.textContent = `Modo muy dif√≠cil PD. Buscando en: ${candidates.map(c => c.replace(location.origin,'')).join('  ‚Ä¢  ')}`;
      for(const url of candidates){
        try{
          setStatus('Cargando (PD muy dif√≠cil): ' + url);
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const txt = (await r.text()).replace(/^\uFEFF/, '');
          const data = JSON.parse(txt);
          const arr = Array.isArray(data) ? data : (data.preguntas || []);
          if(!Array.isArray(arr) || arr.length===0) throw new Error('JSON vac√≠o o estructura inesperada');
          difficultyMode = 'hard';
          allQuestions = arr.map(q => ({...q}));
          questions = allQuestions.slice();
          populateTemas();
          index = 0; modeExam=false; userAnswers={}; doubts=new Set(); checkedQuestions=new Set();
          updateView();
          setStatus('Banco PD muy dif√≠cil cargado.');
          return true;
        }catch(e){
          console.warn('No se pudo cargar PD dif√≠cil en', url, e);
        }
      }
      setStatus('No se pudo cargar el JSON de PD muy dif√≠cil.');
      alert('No se encontr√≥ el JSON de PD muy dif√≠cil. Aseg√∫rate de que existe y tiene el formato correcto.');
      return false;
    }
    // ========= FIN NUEVO =========

    // ========= Generador de preguntas PD (fallback simple) =========
    function generatePDQuestions(){
      const providers = [
        { name:'AWS', tema:'AWS', sv:{
          object:'Amazon S3', vm:'Amazon EC2', sql:'Amazon RDS', k8s:'Amazon EKS', container:'Amazon ECS',
          functions:'AWS Lambda', cdn:'Amazon CloudFront', monitoring:'Amazon CloudWatch',
          queue:'Amazon SQS', nosql:'Amazon DynamoDB', iac:'AWS CloudFormation', identity:'AWS IAM'
        }},
        { name:'Azure', tema:'Azure', sv:{
          object:'Azure Blob Storage', vm:'Azure Virtual Machines', sql:'Azure SQL Database', k8s:'Azure Kubernetes Service (AKS)', container:'Azure Container Instances',
          functions:'Azure Functions', cdn:'Azure CDN', monitoring:'Azure Monitor',
          queue:'Azure Queue Storage', nosql:'Azure Cosmos DB', iac:'Azure Resource Manager (ARM/Bicep)', identity:'Azure Active Directory (Entra ID)'
        }},
        { name:'GCP', tema:'GCP', sv:{
          object:'Google Cloud Storage', vm:'Compute Engine', sql:'Cloud SQL', k8s:'Google Kubernetes Engine (GKE)', container:'Cloud Run',
          functions:'Cloud Functions', cdn:'Cloud CDN', monitoring:'Cloud Monitoring',
          queue:'Pub/Sub', nosql:'Firestore', iac:'Deployment Manager', identity:'Cloud IAM'
        }}
      ];

      const pools = {
        object:['Amazon S3','Azure Blob Storage','Google Cloud Storage','Amazon EBS','Azure Files','EFS'],
        vm:['Amazon EC2','Azure Virtual Machines','Compute Engine','AWS Fargate','App Engine','App Service'],
        sql:['Amazon RDS','Azure SQL Database','Cloud SQL','Cloud Spanner','BigQuery','DynamoDB'],
        k8s:['Amazon EKS','Azure Kubernetes Service (AKS)','Google Kubernetes Engine (GKE)','Amazon ECS','App Service','Cloud Run'],
        functions:['AWS Lambda','Azure Functions','Cloud Functions','AWS Fargate','Cloud Run','App Service'],
        cdn:['Amazon CloudFront','Azure CDN','Cloud CDN','Azure Front Door','S3 Transfer Acceleration','Cloudflare'],
        monitoring:['Amazon CloudWatch','Azure Monitor','Cloud Monitoring','Datadog','New Relic','Prometheus'],
        queue:['Amazon SQS','Azure Queue Storage','Pub/Sub','Amazon Kinesis','Azure Service Bus','RabbitMQ'],
        nosql:['Amazon DynamoDB','Azure Cosmos DB','Firestore','Bigtable','Redis','MongoDB Atlas'],
        iac:['AWS CloudFormation','Azure Resource Manager (ARM/Bicep)','Deployment Manager','Terraform','Pulumi','Ansible'],
        identity:['AWS IAM','Azure Active Directory (Entra ID)','Cloud IAM','Okta','Auth0','Keycloak']
      };

      const wrong3 = (correct, arr) => {
        const pool = arr.filter(x => x !== correct);
        const pick = [];
        while(pick.length<3 && pool.length){
          const i = Math.floor(Math.random()*pool.length);
          pick.push(pool.splice(i,1)[0]);
        }
        return pick;
      };

      const qprov = (p, field, texto) => ({
        tema: p.tema,
        enunciado: texto,
        opciones: [p.sv[field], ...wrong3(p.sv[field], pools[field])],
        correcta: 0
      });

      let out = [];
      providers.forEach(p=>{
        out.push(qprov(p,'object',`[PD] ¬øQu√© servicio de ${p.name} es almacenamiento de objetos?`));
        out.push(qprov(p,'vm',`[PD] ¬øQu√© servicio de ${p.name} provee m√°quinas virtuales?`));
        out.push(qprov(p,'sql',`[PD] ¬øQu√© servicio administrado de ${p.name} ofrece bases de datos relacionales?`));
        out.push(qprov(p,'nosql',`[PD] ¬øQu√© servicio de ${p.name} es NoSQL clave-valor/documentos?`));
        out.push(qprov(p,'functions',`[PD] ¬øQu√© servicio de ${p.name} permite ejecutar funciones sin servidor?`));
        out.push(qprov(p,'k8s',`[PD] ¬øCu√°l es el servicio gestionado de Kubernetes en ${p.name}?`));
        out.push(qprov(p,'cdn',`[PD] ¬øQu√© servicio de ${p.name} es una red de entrega de contenido (CDN)?`));
        out.push(qprov(p,'monitoring',`[PD] ¬øQu√© servicio de ${p.name} se usa para monitorizaci√≥n y *logging*?`));
        out.push(qprov(p,'queue',`[PD] ¬øQu√© servicio de ${p.name} ofrece colas de mensajer√≠a?`));
        out.push(qprov(p,'iac',`[PD] ¬øQu√© soluci√≥n nativa de ${p.name} es ‚Äúinfraestructura como c√≥digo‚Äù?`));
        out.push(qprov(p,'identity',`[PD] ¬øQu√© servicio de ${p.name} gestiona identidades y permisos?`));
      });

      const conceptos = [
        {
          tema:'Conceptos PD',
          enunciado:'[PD] ¬øCu√°l describe mejor el modelo de ‚Äúresponsabilidad compartida‚Äù?',
          opciones:[
            'El proveedor asegura la seguridad de la nube; el cliente, la seguridad en la nube (configuraciones, datos, identidades).',
            'El proveedor es 100% responsable de todo.',
            'El cliente es 100% responsable de todo.',
            'La responsabilidad se delega a un tercero por completo.'
          ],
          correcta: 0
        },
        {
          tema:'Conceptos PD',
          enunciado:'[PD] ¬øQu√© es una Zona de Disponibilidad (AZ)?',
          opciones:[
            'Uno o m√°s centros de datos aislados dentro de una misma regi√≥n.',
            'Una ciudad donde hay clientes.',
            'Una VPC que segmenta redes privadas.',
            'Un grupo de cuentas bajo una organizaci√≥n.'
          ],
          correcta: 0
        }
      ];

      out = out.concat(conceptos);
      out.sort(()=>Math.random()-0.5);
      return out;
    }

    // ========= Carga manual desde archivo =========
    document.getElementById('fileInput')?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const txt = (await f.text()).replace(/^\uFEFF/,'');
        const data = JSON.parse(txt);
        const arr = Array.isArray(data) ? data : (data.preguntas || []);
        if(!Array.isArray(arr) || arr.length===0) throw new Error('Estructura inesperada o vac√≠a.');

        difficultyMode = 'normal';
        allQuestions = arr.map(q => ({...q}));
        questions = allQuestions.slice();
        populateTemas();
        index = 0; modeExam=false; userAnswers={}; doubts=new Set(); checkedQuestions=new Set();
        updateView(); setStatus('Banco cargado desde archivo.');
      }catch(err){
        alert('JSON inv√°lido: ' + err.message);
      }
    });

    // ========= Controles =========
    document.getElementById('prevBtn').addEventListener('click', ()=>{ if(index>0){ index--; updateView() } });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(index<questions.length-1){ index--; index++; updateView() } else if(index === questions.length-1){ /* nada */ } });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(index<questions.length-1){ index++; updateView() } });
    document.getElementById('doubtBtn').addEventListener('click', ()=>{ toggleDoubt(); });
    document.getElementById('checkBtn').addEventListener('click', ()=>{ checkCurrent(); });
    document.getElementById('examBtn').addEventListener('click', ()=>{ startExam(20) });
    temaFilter.addEventListener('change', ()=>{ filterByTema(temaFilter.value=='Todos'?null:temaFilter.value) });
    temaSelect.addEventListener('change', ()=>{ filterByTema(temaSelect.value=='Todos'?null:temaSelect.value) });
    tryAutoBtn.addEventListener('click', ()=> {
      if(!selectedSubject){ alert('Primero elige una asignatura.'); return; }
      tryAutoLoadForSubject(selectedSubject);
    });
    document.getElementById('changeSubject').addEventListener('click', ()=>{
      appEl.classList.add('hidden');
      landing.classList.remove('hidden');
      selectedSubject = null;
      difficultyMode = 'normal';
      headerTitle.textContent = 'Sin preguntas cargadas';
      enunciado.textContent = 'Selecciona una asignatura para empezar.';
      autoHint.textContent = '';
      regenPDBtn.style.display = 'none';
      pdHardBtn.style.display = 'none';
    });
    regenPDBtn.addEventListener('click', ()=>{
      if(selectedSubject === 'PD'){
        difficultyMode = 'normal';
        allQuestions = generatePDQuestions();
        questions = allQuestions.slice();
        populateTemas();
        index = 0; modeExam=false; userAnswers={}; doubts=new Set(); checkedQuestions=new Set();
        updateView();
        setStatus('Banco PD regenerado.');
      }
    });
    pdHardBtn.addEventListener('click', ()=>{
      if(selectedSubject === 'PD'){
        tryLoadPDHard();
      }else{
        alert('El modo muy dif√≠cil solo est√° disponible para PD.');
      }
    });

    // Botones grandes de la pantalla de selecci√≥n
    document.getElementById('btnITIL').addEventListener('click', ()=> selectSubject('ITIL', true));
    document.getElementById('btnITILHard').addEventListener('click', ()=> selectSubject('ITIL_HARD', true));
    document.getElementById('btnPD').addEventListener('click', ()=> selectSubject('PD', true));

    // Deep-link: ?asignatura=itil|itil_hard|pd
    window.addEventListener('load', ()=>{
      const p = new URLSearchParams(location.search);
      const a = (p.get('asignatura')||'').toUpperCase();
      if(a && SUBJECTS[a]) selectSubject(a, true);
      else setStatus('Elige una asignatura para empezar');
    });

    // ========= L√≥gica de asignatura =========
    function selectSubject(subjectKey, autoLoad=false){
      selectedSubject = subjectKey;
      landing.classList.add('hidden');
      appEl.classList.remove('hidden');

      difficultyMode = (subjectKey === 'ITIL_HARD') ? 'hard' : 'normal';

      document.title = `Tester ${SUBJECTS[subjectKey].label} - Estudio y Examen`;
      headerTitle.textContent = `[${SUBJECTS[subjectKey].label}] Sin preguntas cargadas`;
      autoHint.textContent = `Asignatura: ${SUBJECTS[subjectKey].label}`;

      regenPDBtn.style.display = subjectKey === 'PD' ? 'inline-block' : 'none';
      pdHardBtn.style.display   = subjectKey === 'PD' ? 'inline-block' : 'none';

      setStatus('Preparado');
      if(autoLoad) tryAutoLoadForSubject(subjectKey);
    }

    // ========= Utilidades UI =========
    function populateTemas(){
      const temas = ['Todos',...Array.from(new Set(allQuestions.map(q=>q.tema || 'Sin tema'))).sort()];
      temaSelect.innerHTML = temas.map(t=>`<option>${t}</option>`).join('');
      temaFilter.innerHTML = temaSelect.innerHTML;
      document.getElementById('progressLabel').textContent = `0/${allQuestions.length}`;
    }

    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function updateView(){
      if(questions.length===0){
        headerTitle.textContent=`[${selectedSubject? SUBJECTS[selectedSubject].label : '‚Äî'}] Sin preguntas cargadas`;
        enunciado.textContent='Cargue un JSON con preguntas (bot√≥n ‚ÄúIntentar cargar‚Ä¶‚Äù o ‚ÄúCarga manual‚Äù).';
        opts.innerHTML='';
        progressBar.style.width='0%';
        document.getElementById('progressLabel').textContent = `0/0`;
        return;
      }
      const q = questions[index];
      const opciones = q.opciones.map((op,i)=>({texto:op,i}));
      const mezcladas = shuffle(opciones.slice());
      q._opcionesMezcladas = mezcladas;
      q._correctaIndex = mezcladas.findIndex(op => op.i === q.correcta);

      const subjectLabel = SUBJECTS[selectedSubject]?.label || '‚Äî';
      const diffLabel = difficultyMode === 'hard' ? ' (Muy dif√≠cil)' : '';
      headerTitle.textContent = `[${subjectLabel}${diffLabel}] ${q.tema || 'Tema'} ‚Äî Pregunta ${index+1}/${questions.length} [${modeExam? 'Examen':'Estudio'}]`;

      enunciado.textContent = q.enunciado;
      opts.innerHTML = '';

      mezcladas.forEach((op,i)=>{
        const div = document.createElement('div');
        div.className='opt'; div.dataset.i=i;
        div.innerHTML = `<strong>${'abcd'[i]})</strong> ${op.texto}`;
        div.addEventListener('click', ()=>selectOption(i));
        opts.appendChild(div);
      });

      const sel = userAnswers[index] ?? -1;
      if(sel!==-1) selectDOMOption(sel,false);

      feedback.textContent=''; solution.textContent='';
      const pct = Math.round(((index+1)/questions.length)*100);
      progressBar.style.width = pct + '%';
      document.getElementById('progressLabel').textContent = `${index+1}/${questions.length}`;
      refreshDoubtsList();
      setStatus('Listo');
    }

    function selectOption(i){ userAnswers[index]=i; selectDOMOption(i,true) }
    function selectDOMOption(i){
      document.querySelectorAll('.opt').forEach(el=>el.classList.remove('selected','correct','wrong'));
      const el = document.querySelector(`.opt[data-i='${i}']`);
      if(el) el.classList.add('selected');
    }

    function checkCurrent(){
      const q = questions[index];
      const sel = userAnswers[index] ?? -1;
      if(sel===-1){
        feedback.textContent='No has seleccionado una opci√≥n.';
        feedback.style.color='var(--muted)';
        solution.textContent=`Soluci√≥n: ${'abcd'[q._correctaIndex]}) ${q._opcionesMezcladas[q._correctaIndex].texto}`;
        return;
      }
      checkedQuestions.add(index);
      if(sel===q._correctaIndex){
        feedback.textContent='‚úî ¬°Correcto!'; feedback.style.color='var(--success)';
        document.querySelector(`.opt[data-i='${sel}']`).classList.add('correct');
      }else{
        feedback.textContent='‚úñ Incorrecto.'; feedback.style.color='var(--danger)';
        document.querySelector(`.opt[data-i='${sel}']`).classList.add('wrong');
        solution.textContent=`Soluci√≥n: ${'abcd'[q._correctaIndex]}) ${q._opcionesMezcladas[q._correctaIndex].texto}`;
      }
    }

    function toggleDoubt(){ doubts.has(index)? doubts.delete(index): doubts.add(index); refreshDoubtsList() }
    function refreshDoubtsList(){
      doubtsList.innerHTML=''; if(doubts.size===0){ doubtsList.textContent='‚Äî'; return }
      Array.from(doubts).sort((a,b)=>a-b).forEach(i=>{
        const q=questions[i]; const el=document.createElement('div');
        el.textContent=`${i+1}. ${q.tema||'Tema'}`; el.style.padding='4px 6px'; el.style.cursor='pointer';
        el.addEventListener('click', ()=>{ index=i; updateView() }); doubtsList.appendChild(el);
      });
    }

    function filterByTema(tema){
      questions = tema? allQuestions.filter(q=>q.tema===tema) : allQuestions.slice();
      index=0; userAnswers={}; doubts=new Set(); modeExam=false; populateTemas(); updateView();
    }

    function startExam(num){
      if(allQuestions.length===0) return alert('Carga primero preguntas.');
      modeExam=true; userAnswers={}; doubts=new Set();
      questions = [...allQuestions].sort(()=>Math.random()-0.5).slice(0,Math.min(num,allQuestions.length));
      index=0; updateView();
    }
  </script>
</body>
</html>
